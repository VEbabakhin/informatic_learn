{% extends 'users/base.html' %}

{% block title %}Добавление заданий в урок "{{ lesson.get_full_title }}"{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Заголовок -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h1>Добавление заданий в урок</h1>
                    <h4 class="text-muted">{{ lesson.get_full_title }}</h4>
                    <div class="d-flex align-items-center gap-3">
                        <small class="text-muted">
                            <i class="bi bi-book"></i> Курс: {{ lesson.course.title }}
                        </small>
                        <small class="text-muted">
                            <i class="bi bi-person"></i> {{ lesson.course.created_by.get_full_name }}
                        </small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'courses:lesson_tasks' course.id lesson.id %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Вернуться к уроку
                    </a>
                    <button id="save-selected-tasks" class="btn btn-success" disabled>
                        <i class="bi bi-check-circle"></i> Сохранить выбранные задания
                    </button>
                </div>
            </div>

            <!-- Фильтры -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Фильтры заданий</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        {% csrf_token %}
                        <div class="col-md-2">
                            {{ filter_form.task_id }}
                        </div>
                        <div class="col-md-2">
                            {{ filter_form.task_type }}
                        </div>
                        <div class="col-md-2">
                            {{ filter_form.subtype }}
                        </div>
                        <div class="col-md-2">
                            {{ filter_form.difficulty }}
                        </div>
                        <div class="col-md-3">
                            {{ filter_form.search }}
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="submit" class="btn btn-outline-primary me-2">Применить</button>
                        </div>
                    </form>
                    <div class="mt-2">
                        <a href="{% url 'courses:add_tasks_to_lesson' course.id lesson.id %}" class="btn btn-outline-secondary btn-sm">Сбросить фильтры</a>
                    </div>
                </div>
            </div>

            <!-- Список заданий -->
            <div id="tasks-container" class="row">
                {% if page_obj %}
                    {% for task in page_obj %}
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-dark">#{{ task.id }}</span>
                                        <span class="badge bg-{% if task.difficulty == 'easy' %}success{% elif task.difficulty == 'medium' %}warning{% else %}danger{% endif %}">
                                            {{ task.get_difficulty_display }}
                                        </span>
                                        <span class="badge bg-primary">{{ task.get_task_type_display }}</span>
                                        {% if task.subtype %}
                                            <span class="badge bg-secondary">{{ task.get_subtype_display }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="d-flex gap-2 align-items-center">
                                        <a href="{% url 'task_detail' task.id %}?return_url={% url 'courses:add_tasks_to_lesson' course.id lesson.id %}" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-eye"></i> Просмотреть
                                        </a>
                                        {% if task.id in added_task_ids %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle"></i> Уже добавлено
                                            </span>
                                        {% else %}
                                            <div class="form-check">
                                                <input class="form-check-input task-checkbox" 
                                                       type="checkbox" 
                                                       value="{{ task.id }}" 
                                                       id="task_{{ task.id }}">
                                                <label class="form-check-label" for="task_{{ task.id }}">
                                                    Выбрать
                                                </label>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        {% if task.is_html %}
                                            <div class="task-html-content">{{ task.text|safe }}</div>
                                        {% else %}
                                            {{ task.text|linebreaks }}
                                        {% endif %}
                                    </div>
                                    
                                    {% if task.image %}
                                        <div class="mb-3">
                                            <strong>Изображение:</strong>
                                            <div class="mt-2">
                                                <img src="{{ task.image.url }}" alt="Изображение к заданию" class="img-fluid" style="max-width: 500px;">
                                            </div>
                                        </div>
                                    {% endif %}
                                    
                                    {% if task.file %}
                                        <div class="mb-3">
                                            <div class="mt-2">
                                                <a href="{{ task.file.url }}" class="btn btn-sm btn-outline-primary" download>
                                                    <i class="bi bi-download"></i> Скачать файл
                                                </a>
                                            </div>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="alert alert-info mb-0">
                                        <strong>Правильный ответ:</strong><br>
                                        <div class="task-answer">{{ task.correct_answer|safe }}</div>
                                    </div>
                                    
                                    <div class="mt-3 d-flex justify-content-between align-items-center text-muted small">
                                        <div>
                                            <i class="bi bi-calendar"></i> {{ task.created_at|date:"d.m.Y H:i" }}
                                        </div>
                                        <div>
                                            <i class="bi bi-person"></i> {{ task.created_by.get_full_name }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                {% else %}
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="bi bi-journal-text display-1 text-muted"></i>
                            <h3 class="mt-3">Задания не найдены</h3>
                            <p class="text-muted">По выбранным фильтрам задания не найдены.</p>
                            <a href="{% url 'courses:add_tasks_to_lesson' course.id lesson.id %}" class="btn btn-primary">
                                <i class="bi bi-arrow-clockwise"></i> Сбросить фильтры
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Индикатор загрузки -->
            <div id="loading-indicator" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-2">Загружаем задания...</p>
            </div>
        </div>
    </div>
</div>

<!-- Уведомления -->
<div id="alert-container" class="position-fixed" style="top: 20px; right: 20px; z-index: 1050;"></div>

<!-- Плавающий счетчик выбранных заданий -->
<div id="floating-counter" class="position-fixed" style="top: 20px; left: 20px; z-index: 1040; display: none; cursor: pointer;" title="Нажмите для перехода к кнопке сохранения">
    <div class="card shadow-lg border-0" style="border-radius: 15px; background: linear-gradient(135deg, #ffffff, #f8f9fa);">
        <div class="card-body p-3 text-center">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 1.2rem;"></i>
                <div>
                    <div class="fw-bold text-dark" id="selected-count">0</div>
                    <small class="text-muted">выбрано</small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    #floating-counter {
        transition: all 0.3s ease;
    }
    
    #floating-counter .card {
        border: 2px solid var(--success-soft);
        box-shadow: 0 4px 20px rgba(40, 167, 69, 0.2) !important;
        min-width: 120px;
    }
    
    #floating-counter:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 6px 25px rgba(40, 167, 69, 0.3) !important;
    }
    
    #selected-count {
        font-size: 1.2rem;
        color: var(--success-soft) !important;
        font-weight: 700;
    }
    
    /* Анимация появления слева */
    #floating-counter.show {
        animation: slideInFromLeft 0.3s ease-out;
    }
    
    @keyframes slideInFromLeft {
        from {
            transform: translateX(-100px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

       <script>
       document.addEventListener('DOMContentLoaded', function() {
           const saveButton = document.getElementById('save-selected-tasks');
           let currentPage = 1;
           let isLoading = false;
           let hasMorePages = true;
           
           // Инициализация
           initializeCheckboxes();
           setupInfiniteScroll();
           setupFilterForm();
           setupFloatingCounter();
           
           // Функция инициализации чекбоксов
           function initializeCheckboxes() {
               const checkboxes = document.querySelectorAll('.task-checkbox');
               checkboxes.forEach(function(checkbox) {
                   checkbox.addEventListener('change', function() {
                       updateSaveButton();
                   });
               });
           }
           
           // Функция настройки бесконечной прокрутки
           function setupInfiniteScroll() {
               window.addEventListener('scroll', function() {
                   if (isLoading || !hasMorePages) return;
                   
                   const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                   const windowHeight = window.innerHeight;
                   const documentHeight = document.documentElement.scrollHeight;
                   
                   // Загружаем следующую страницу когда пользователь прокрутил на 80% страницы
                   if (scrollTop + windowHeight >= documentHeight * 0.8) {
                       loadNextPage();
                   }
               });
           }
           
           // Функция настройки AJAX фильтрации
           function setupFilterForm() {
               const filterForm = document.querySelector('form[method="get"]');
               if (!filterForm) return;
               
               // Сохраняем выбранные задания перед фильтрацией
               const selectedTasks = getSelectedTasks();
               
               filterForm.addEventListener('submit', function(e) {
                   e.preventDefault();
                   
                   // Сохраняем текущие выбранные задания
                   const currentSelected = getSelectedTasks();
                   
                   // Сбрасываем пагинацию и состояние
                   currentPage = 1;
                   hasMorePages = true;
                   
                   // Показываем индикатор загрузки
                   const loadingIndicator = document.getElementById('loading-indicator');
                   loadingIndicator.style.display = 'block';
                   
                   // Получаем данные формы
                   const formData = new FormData(filterForm);
                   const urlParams = new URLSearchParams(formData);
                   
                   // Отправляем AJAX запрос
                   fetch(`?${urlParams.toString()}`, {
                       method: 'GET',
                       headers: {
                           'X-Requested-With': 'XMLHttpRequest',
                       },
                   })
                   .then(response => response.text())
                   .then(html => {
                       // Очищаем контейнер и добавляем новые задания
                       const tasksContainer = document.getElementById('tasks-container');
                       tasksContainer.innerHTML = html;
                       
                       // Инициализируем чекбоксы для новых заданий
                       initializeCheckboxes();
                       
                       // Восстанавливаем выбранные задания
                       restoreSelectedTasks(currentSelected);
                       
                       // Обновляем состояние кнопки сохранения
                       updateSaveButton();
                   })
                   .catch(error => {
                       console.error('Ошибка фильтрации заданий:', error);
                       showAlert('danger', 'Ошибка при применении фильтров');
                   })
                   .finally(() => {
                       loadingIndicator.style.display = 'none';
                   });
               });
               
               // Обработка изменения типа задания для обновления подтипов и применения фильтра
               const taskTypeSelect = filterForm.querySelector('select[name="task_type"]');
               if (taskTypeSelect) {
                   taskTypeSelect.addEventListener('change', function() {
                       updateSubtypes(this.value);
                       // Автоматически применяем фильтр при изменении типа
                       filterForm.dispatchEvent(new Event('submit'));
                   });
               }
               
               // Обработка изменения других полей фильтрации
               const filterInputs = filterForm.querySelectorAll('select[name="subtype"], select[name="difficulty"], input[name="search"], input[name="task_id"]');
               filterInputs.forEach(function(input) {
                   input.addEventListener('change', function() {
                       // Автоматически применяем фильтр при изменении
                       filterForm.dispatchEvent(new Event('submit'));
                   });
               });
           }
           
           // Функция загрузки следующей страницы
           function loadNextPage() {
               if (isLoading || !hasMorePages) return;
               
               isLoading = true;
               currentPage++;
               
               // Сохраняем текущие выбранные задания
               const currentSelected = getSelectedTasks();
               
               // Показываем индикатор загрузки
               const loadingIndicator = document.getElementById('loading-indicator');
               loadingIndicator.style.display = 'block';
               
               // Получаем параметры фильтрации из формы
               const filterForm = document.querySelector('form[method="get"]');
               const formData = new FormData(filterForm);
               const urlParams = new URLSearchParams(formData);
               urlParams.set('page', currentPage);
               
               // Отправляем AJAX запрос
               fetch(`?${urlParams.toString()}`, {
                   method: 'GET',
                   headers: {
                       'X-Requested-With': 'XMLHttpRequest',
                   },
               })
               .then(response => response.text())
               .then(html => {
                   if (html.trim()) {
                       // Добавляем новые задания в контейнер
                       const tasksContainer = document.getElementById('tasks-container');
                       tasksContainer.insertAdjacentHTML('beforeend', html);
                       
                       // Инициализируем чекбоксы для новых заданий
                       initializeCheckboxes();
                       
                       // Восстанавливаем выбранные задания
                       restoreSelectedTasks(currentSelected);
                       
                       // Обновляем состояние кнопки сохранения
                       updateSaveButton();
                   } else {
                       // Больше страниц нет
                       hasMorePages = false;
                   }
               })
               .catch(error => {
                   console.error('Ошибка загрузки заданий:', error);
                   hasMorePages = false;
               })
               .finally(() => {
                   isLoading = false;
                   loadingIndicator.style.display = 'none';
               });
           }
           
           // Обработка кнопки сохранения
           saveButton.addEventListener('click', function() {
               const selectedTasks = Array.from(document.querySelectorAll('.task-checkbox'))
                   .filter(cb => cb.checked)
                   .map(cb => cb.value);
               
               if (selectedTasks.length === 0) {
                   showAlert('warning', 'Выберите хотя бы одно задание для добавления');
                   return;
               }
               
               // Показываем индикатор загрузки
               const originalText = this.innerHTML;
               this.innerHTML = '<i class="bi bi-hourglass-split"></i> Сохраняем...';
               this.disabled = true;
               
               // Отправляем AJAX запрос для добавления всех выбранных заданий
               addSelectedTasks(selectedTasks, originalText);
           });
           
           // Функция для обновления состояния кнопки сохранения
           function updateSaveButton() {
               const selectedCount = Array.from(document.querySelectorAll('.task-checkbox')).filter(cb => cb.checked).length;
               saveButton.disabled = selectedCount === 0;
               
               if (selectedCount > 0) {
                   saveButton.innerHTML = `<i class="bi bi-check-circle"></i> Сохранить выбранные задания (${selectedCount})`;
               } else {
                   saveButton.innerHTML = '<i class="bi bi-check-circle"></i> Сохранить выбранные задания';
               }
               
               // Обновляем плавающий счетчик
               updateFloatingCounter(selectedCount);
           }
           
           // Функция для обновления плавающего счетчика
           function updateFloatingCounter(selectedCount) {
               const floatingCounter = document.getElementById('floating-counter');
               const selectedCountElement = document.getElementById('selected-count');
               
               if (selectedCount > 0) {
                   floatingCounter.style.display = 'block';
                   selectedCountElement.textContent = selectedCount;
                   
                   // Добавляем анимацию появления слева
                   floatingCounter.classList.add('show');
                   
                   // Убираем класс анимации после завершения
                   setTimeout(() => {
                       floatingCounter.classList.remove('show');
                   }, 300);
               } else {
                   // Скрываем с анимацией
                   floatingCounter.style.opacity = '0';
                   floatingCounter.style.transform = 'translateX(-100px)';
                   
                   setTimeout(() => {
                       floatingCounter.style.display = 'none';
                       floatingCounter.style.opacity = '1';
                       floatingCounter.style.transform = 'translateX(0)';
                   }, 300);
               }
           }
           
           // Функция настройки плавающего счетчика
           function setupFloatingCounter() {
               const floatingCounter = document.getElementById('floating-counter');
               
               floatingCounter.addEventListener('click', function() {
                   // Плавно прокручиваем к кнопке сохранения
                   saveButton.scrollIntoView({ 
                       behavior: 'smooth', 
                       block: 'center' 
                   });
                   
                   // Добавляем визуальный эффект для кнопки
                   saveButton.style.transform = 'scale(1.05)';
                   saveButton.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.5)';
                   
                   setTimeout(() => {
                       saveButton.style.transform = 'scale(1)';
                       saveButton.style.boxShadow = '';
                   }, 500);
               });
           }
           
           // Функция получения выбранных заданий
           function getSelectedTasks() {
               const selectedTasks = {};
               document.querySelectorAll('.task-checkbox:checked').forEach(function(checkbox) {
                   selectedTasks[checkbox.value] = true;
               });
               return selectedTasks;
           }
           
           // Функция восстановления выбранных заданий
           function restoreSelectedTasks(selectedTasks) {
               Object.keys(selectedTasks).forEach(function(taskId) {
                   const checkbox = document.querySelector(`input[value="${taskId}"]`);
                   if (checkbox && !checkbox.disabled) {
                       checkbox.checked = true;
                   }
               });
           }
           
           // Функция обновления подтипов при изменении типа задания
           function updateSubtypes(taskType) {
               const subtypeSelect = document.querySelector('select[name="subtype"]');
               if (!subtypeSelect) return;
               
               // Очищаем текущие опции
               subtypeSelect.innerHTML = '<option value="">Все подтипы</option>';
               
               // Определяем подтипы в зависимости от типа задания
               const subtypes = {
                   '1': [
                       ['', 'Все подтипы'],
                       ['1.1', '1.1 - Информация и её кодирование'],
                       ['1.2', '1.2 - Алгоритмизация и программирование'],
                       ['1.3', '1.3 - Моделирование и компьютерный эксперимент']
                   ],
                   '2': [
                       ['', 'Все подтипы'],
                       ['2.1', '2.1 - Элементы теории множеств'],
                       ['2.2', '2.2 - Элементы математической логики'],
                       ['2.3', '2.3 - Элементы теории алгоритмов']
                   ],
                   '3': [
                       ['', 'Все подтипы'],
                       ['3.1', '3.1 - Системы счисления'],
                       ['3.2', '3.2 - Арифметические операции в различных системах счисления']
                   ]
               };
               
               if (subtypes[taskType]) {
                   subtypes[taskType].forEach(function(subtype) {
                       const option = document.createElement('option');
                       option.value = subtype[0];
                       option.textContent = subtype[1];
                       subtypeSelect.appendChild(option);
                   });
               }
           }
           
           // Функция для добавления выбранных заданий
           function addSelectedTasks(taskIds, originalText) {
               const courseId = '{{ course.id }}';
               const lessonId = '{{ lesson.id }}';
               let completed = 0;
               let errors = 0;
               
               taskIds.forEach(function(taskId) {
                   fetch(`/courses/${courseId}/lesson/${lessonId}/add-task/${taskId}/`, {
                       method: 'POST',
                       headers: {
                           'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                           'Content-Type': 'application/json',
                       },
                   })
                   .then(response => response.json())
                   .then(data => {
                       completed++;
                       
                       if (data.success) {
                           // Помечаем задание как добавленное
                           const checkbox = document.querySelector(`#task_${taskId}`);
                           const card = checkbox.closest('.col-12');
                           const checkboxContainer = checkbox.closest('.form-check');
                           
                           // Заменяем чекбокс на бейдж "Уже добавлено"
                           checkboxContainer.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Уже добавлено</span>';
                           
                           // Добавляем визуальный эффект
                           card.style.transition = 'all 0.3s ease';
                           card.style.backgroundColor = '#d4edda';
                           setTimeout(() => {
                               card.style.backgroundColor = '';
                           }, 2000);
                       } else {
                           errors++;
                           console.error('Ошибка добавления задания:', data.message);
                       }
                       
                       // Проверяем, все ли задания обработаны
                       if (completed === taskIds.length) {
                           if (errors === 0) {
                               showAlert('success', `Успешно добавлено ${taskIds.length} заданий!`);
                           } else {
                               showAlert('warning', `Добавлено ${taskIds.length - errors} из ${taskIds.length} заданий. ${errors} заданий не удалось добавить.`);
                           }
                           
                           // Восстанавливаем кнопку
                           saveButton.innerHTML = originalText;
                           saveButton.disabled = true;
                       }
                   })
                   .catch(error => {
                       completed++;
                       errors++;
                       console.error('Error:', error);
                       
                       if (completed === taskIds.length) {
                           showAlert('danger', `Произошла ошибка при добавлении заданий. Добавлено ${taskIds.length - errors} из ${taskIds.length}.`);
                           
                           // Восстанавливаем кнопку
                           saveButton.innerHTML = originalText;
                           saveButton.disabled = true;
                       }
                   });
               });
           }
           
           // Функция для показа уведомлений
           function showAlert(type, message) {
               const alertContainer = document.getElementById('alert-container');
               const alertId = 'alert-' + Date.now();
               
               const alertHtml = `
                   <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                       ${message}
                       <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                   </div>
               `;
               
               alertContainer.insertAdjacentHTML('beforeend', alertHtml);
               
               // Автоматически скрываем уведомление через 5 секунд
               setTimeout(() => {
                   const alert = document.getElementById(alertId);
                   if (alert) {
                       alert.remove();
                   }
               }, 5000);
           }
       });
       </script>
{% endblock %}
