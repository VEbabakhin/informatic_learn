from django.db import models
from django.contrib.auth import get_user_model

User = get_user_model()

class Task(models.Model):
    TASK_TYPE_CHOICES = [
        ('1', '1. Анализ информационных моделей'),
        ('2', '2. Построение таблиц истинности логических выражений'),
        ('3', '3. Поиск информации в реляционных базах данных'),
        ('4', '4. Кодирование и декодирование данных. Условие Фано'),
        ('5', '5. Анализ алгоритмов для исполнителей'),
        ('6', '6. Циклические алгоритмы для исполнителя'),
        ('7', '7. Кодирование графической и звуковой информации'),
        ('8', '8. Комбинаторика'),
        ('9', '9. Обработка числовой информации в электронных таблицах'),
        ('10', '10. Поиск слова в текстовом документе'),
        ('11', '11. Вычисление количества информации'),
        ('12', '12. Алгоритмы для исполнителей с циклами и ветвлениями'),
        ('13', '13. IP адресация'),
        ('14', '14. Позиционные системы счисления'),
        ('15', '15. Истинность логического выражения'),
        ('16', '16. Вычисление значения рекурсивной функции'),
        ('17', '17. Обработка целочисленных данных'),
        ('18', '18. Робот-сборщик монет'),
        ('19-21', '19-21. Теория игр'),
        ('1921', '19-21. Теория игр'),
        ('22', '22. Многопоточные вычисления'),
        ('23', '23. Динамическое программирование. Количество программ'),
        ('24', '24. Обработка тестовых файлов'),
        ('25', '25. Обработка целочисленных данных. Поиск делителей'),
        ('26', '26. Обработка данных с помощью сортировки'),
        ('27', '27. Анализ данных. Кластеризация'),
    ]

    SUBTYPE_CHOICES = {
        '1': [('1', 'Соотнесение таблицы и графа')],
        '2': [('2', 'Строки с пропущенными значениями')],
        '3': [('3', 'Поиск информации в реляционных базах данных')],
        '4': [('4', 'Кодирование и декодирование данных. Условие Фано')],
        '5': [('5', 'Анализ алгоритмов для исполнителей')],
        '6': [('6', 'Циклические алгоритмы для исполнителя')],
        '7': [
            ('7', 'Кодирование изображений'),
            ('7_1', 'Кодирование звуков'),
        ],
        '8': [
            ('8_1', 'Слова по порядку'),
            ('8_2', 'Подсчет комбинаций'),
        ],
        '9': [('9', 'Обработка числовой информации в электронных таблицах')],
        '10': [('10', 'Поиск слова в текстовом документе')],
        '11': [('11', 'Вычисление количества информации')],
        '12': [('12', 'Алгоритмы для исполнителей с циклами и ветвлениями')],
        '13': [('13', 'IP адресация')],
        '14': [
            ('14_1', 'Перевод из 10 с.с.'),
            ('14_2', 'Перевод в 10 с.с.'),
        ],
        '15': [
            ('15_1', 'Поиск полным перебором'),
            ('15_2', 'Задания на отрезки'),
        ],
        '16': [
            ('16_1', 'Без использования кеширования'),
            ('16_2', 'С использованием кеширования'),
        ],
        '17': [('17', 'Обработка целочисленных данных')],
        '18': [('18', 'Робот-сборщик монет')],
        '19': [('19', 'Теория игр')],
        '20': [('20', 'Теория игр')],
        '21': [('21', 'Теория игр')],
        '1921': [
            ('19_21_1', 'Задания на 1 кучу'),
            ('19_21_2', 'Задания на 2 кучи'),
            ('19_21_3', 'Задания на 3 кучи'),
        ],
        '22': [('22', 'Многопоточные вычисления')],
        '23': [('23', 'Динамическое программирование. Количество программ')],
        '24': [('24', 'Обработка тестовых файлов')],
        '25': [('25', 'Обработка целочисленных данных. Поиск делителей')],
        '26': [('26', 'Обработка данных с помощью сортировки')],
        '27': [('27', 'Анализ данных. Кластеризация')],
    }

    DIFFICULTY_CHOICES = [
        ('easy', 'Легкая'),
        ('medium', 'Средняя'),
        ('hard', 'Сложная'),
    ]

    text = models.TextField(verbose_name='Текст задания')
    task_type = models.CharField(max_length=10, choices=TASK_TYPE_CHOICES, verbose_name='Тип задания')
    subtype = models.CharField(max_length=20, blank=True, null=True, verbose_name='Подтип задания')
    difficulty = models.CharField(max_length=10, choices=DIFFICULTY_CHOICES, default='easy', verbose_name='Сложность')
    correct_answer = models.TextField(verbose_name='Правильный ответ')
    is_html = models.BooleanField(default=False, verbose_name='HTML разметка')
    image = models.ImageField(upload_to='tasks/images/', blank=True, null=True, verbose_name='Изображение')
    file = models.FileField(upload_to='tasks/files/', blank=True, null=True, verbose_name='Файл для решения')
    created_by = models.ForeignKey(User, on_delete=models.CASCADE, related_name='created_tasks', verbose_name='Создано')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='Дата создания')
    updated_at = models.DateTimeField(auto_now=True, verbose_name='Дата обновления')

    class Meta:
        verbose_name = 'Задание'
        verbose_name_plural = 'Задания'
        ordering = ['-created_at']

    def __str__(self):
        return f"Задание {self.id} - {self.get_task_type_display()}"

    def get_subtype_choices(self):
        """Возвращает варианты подтипов для выбранного типа задания"""
        return self.SUBTYPE_CHOICES.get(self.task_type, [])

    def get_subtype_display(self):
        """Возвращает отображаемое название подтипа"""
        choices = self.get_subtype_choices()
        for choice_value, choice_display in choices:
            if choice_value == self.subtype:
                return choice_display
        return self.subtype