{% extends 'users/base.html' %}

{% block title %}Главная страница{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Платформа изучения информатики и подготовки к ЕГЭ</h1>
    </div>
</div>

{% if user.role == 'student' %}
    <!-- Вкладки для учеников -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="lessonTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="assigned-tab" data-bs-toggle="tab" data-bs-target="#assigned" type="button" role="tab">
                        <i class="bi bi-calendar-check"></i> Заданные уроки
                        {% if assigned_executions %}
                            <span class="badge bg-primary ms-2">{{ assigned_executions|length }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab">
                        <i class="bi bi-check-circle"></i> Завершенные уроки
                        {% if completed_executions %}
                            <span class="badge bg-success ms-2">{{ completed_executions|length }}</span>
                        {% endif %}
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="lessonTabsContent">
                <!-- Заданные уроки -->
                <div class="tab-pane fade show active" id="assigned" role="tabpanel">
                    <div class="row mt-4">
                        {% if assigned_executions %}
                            {% for execution in assigned_executions %}
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea, #764ba2) !important;">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h5 class="card-title mb-0 text-white">
                                                    {{ execution.lesson.title }}
                                                </h5>
                                                <span class="badge bg-white text-dark">{{ execution.get_total_tasks }} заданий</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-light text-dark">
                                                    {% if execution.lesson.lesson_type == 'classwork' %}
                                                        <i class="bi bi-pencil"></i> Классная работа
                                                    {% elif execution.lesson.lesson_type == 'homework' %}
                                                        <i class="bi bi-house"></i> Домашняя работа
                                                    {% else %}
                                                        <i class="bi bi-clipboard-check"></i> Контрольная работа
                                                    {% endif %}
                                                </span>
                                                <small class="text-white-50">{{ execution.assignment.assigned_at|date:"d.m.Y H:i" }}</small>
                                            </div>
                                        </div>
                                        <div class="card-body d-flex flex-column text-dark">
                                            <div class="mb-3">
                                                <p class="card-text">
                                                    <strong>Назначил:</strong> {{ execution.assignment.assigned_by.get_full_name|default:execution.assignment.assigned_by.username }}
                                                </p>
                                                {% if execution.assignment.description %}
                                                    <p class="card-text text-muted small">{{ execution.assignment.description }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="mt-auto">
                                                {% if execution.status == 'assigned' %}
                                                    <a href="{% url 'courses:start_lesson' execution.id %}" class="btn btn-success w-100">
                                                        <i class="bi bi-play-circle"></i> Выполнить урок
                                                    </a>
                                                {% elif execution.status == 'in_progress' %}
                                                    <a href="{% url 'courses:start_lesson' execution.id %}" class="btn btn-warning w-100">
                                                        <i class="bi bi-arrow-clockwise"></i> Продолжить урок
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12">
                                <div class="text-center py-5">
                                    <i class="bi bi-calendar-x display-1 text-muted mb-3"></i>
                                    <h4 class="text-muted">Вам пока не назначены уроки</h4>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Завершенные уроки -->
                <div class="tab-pane fade" id="completed" role="tabpanel">
                    <div class="row mt-4">
                        {% if completed_executions %}
                            {% for execution in completed_executions %}
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea, #764ba2) !important;">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h5 class="card-title mb-0 text-white">
                                                    {{ execution.lesson.title }}
                                                </h5>
                                                <span class="badge bg-white text-dark">{{ execution.get_total_tasks }} заданий</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-light text-dark">
                                                    {% if execution.lesson.lesson_type == 'classwork' %}
                                                        <i class="bi bi-pencil"></i> Классная работа
                                                    {% elif execution.lesson.lesson_type == 'homework' %}
                                                        <i class="bi bi-house"></i> Домашняя работа
                                                    {% else %}
                                                        <i class="bi bi-clipboard-check"></i> Контрольная работа
                                                    {% endif %}
                                                </span>
                                                <small class="text-white-50">{{ execution.completed_at|date:"d.m.Y H:i" }}</small>
                                            </div>
                                        </div>
                                        <div class="card-body d-flex flex-column text-dark">
                                            <div class="mb-3">
                                                <p class="card-text">
                                                    <strong>Правильных ответов:</strong> {{ execution.get_correct_answers_count }}/{{ execution.get_total_tasks }}
                                                </p>
                                            </div>
                                            <div class="mt-auto">
                                                <a href="{% url 'courses:view_completed_lesson' execution.id %}" class="btn btn-outline-success w-100">
                                                    <i class="bi bi-eye"></i> Просмотреть результаты
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12">
                                <div class="text-center py-5">
                                    <i class="bi bi-check-circle display-1 text-muted mb-3"></i>
                                    <h4 class="text-muted">Нет завершенных уроков</h4>
                                    <p class="text-muted">Выполните уроки, чтобы они появились здесь.</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Проверяем, есть ли якорь #completed в URL
    if (window.location.hash === '#completed') {
        // Небольшая задержка для полной загрузки вкладок
        setTimeout(function() {
            // Находим вкладку "Завершенные уроки" и переключаемся на неё
            const completedTab = document.getElementById('completed-tab');
            const completedPane = document.getElementById('completed');
            
            if (completedTab && completedPane) {
                // Убираем активный класс с текущей вкладки
                const activeTab = document.querySelector('.nav-link.active');
                const activePane = document.querySelector('.tab-pane.active');
                
                if (activeTab) activeTab.classList.remove('active');
                if (activePane) activePane.classList.remove('active');
                
                // Активируем вкладку "Завершенные уроки"
                completedTab.classList.add('active');
                completedPane.classList.add('active', 'show');
                
                console.log('Переключились на вкладку "Завершенные уроки"');
            }
        }, 100);
    }
});
</script>
{% endblock %}
